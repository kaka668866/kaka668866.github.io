<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <title>Admin - URL Shortener</title>
  <link rel="stylesheet" href="https://kaka668866.github.io/styles.css">
</head>
<body>
  <div class="container mt-4">
    <div class="card shadow">
      <div class="card-header bg-primary text-white">URL Shortener Management</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Long URL</label>
          <input type="text" class="form-control" id="longURL" placeholder="https://example.com">
        </div>
        <div class="mb-3">
          <label class="form-label">Custom Key (Optional)</label>
          <input type="text" class="form-control" id="keyPhrase" placeholder="e.g. my-link">
        </div>
        <button class="btn btn-success w-100" id="addBtn" onclick="shorturl()">Generate Short Link</button>
        <hr>
        <div class="mb-3">
          <label class="form-label">API Status</label>
          <input type="text" class="form-control bg-light" id="apiStatus" readonly>
          <input type="hidden" id="passwordText" value="__PASSWORD__">
        </div>
      </div>
    </div>
  </div>

  <script>
    // 自动检测并显示当前访问的路径，方便你排查
    const currentPath = window.location.pathname;
    document.getElementById('apiStatus').value = "Target API: " + currentPath;

    async function shorturl() {
      const longURL = document.getElementById("longURL").value;
      const keyPhrase = document.getElementById("keyPhrase").value.trim();
      const password = document.getElementById("passwordText").value;
      const btn = document.getElementById("addBtn");

      if (!longURL) { alert("Please enter a URL"); return; }

      btn.disabled = true;
      btn.innerHTML = 'Connecting to Worker...';

      try {
        const response = await fetch(currentPath, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            cmd: "add", 
            url: longURL, 
            key: keyPhrase, 
            password: password 
          })
        });

        if (!response.ok) throw new Error('HTTP Error: ' + response.status);

        const data = await response.json();
        if (data.status === 200) {
          const resultUrl = window.location.origin + "/" + data.key;
          alert("Success! Your link: " + resultUrl);
          window.location.reload(); // 刷新查看新纪录
        } else {
          alert("Worker Error: " + data.error);
        }
      } catch (err) {
        console.error(err);
        alert("连接失败！原因可能是：\n1. SSL 证书尚未生效\n2. 你没有使用 '域名/密码' 访问\n3. Worker 未配置 PASSWORD 变量\n\n报错信息: " + err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Generate Short Link';
      }
    }
  </script>
</body>
</html>
