<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" >
  <title>Kaka - Shorter Terminal</title>
<link rel="stylesheet" href="https://kaka668866.github.io/styles.css?v=1.1">
</head>
<body>

  <div class="container d-flex flex-column gap-4 py-5">
    
    <div class="glass-card mx-auto overflow-hidden">
      <div class="card-header">
        <span class="fs-5">✦ Link Genesis ✦</span>
      </div>
      <div class="card-body p-4">
        <div class="mb-4">
          <label class="small text-uppercase text-muted mb-2 d-block">Target Destination</label>
          <input type="text" class="form-control" id="longURL" placeholder="https://">
        </div>
        
        <div class="mb-4">
          <label class="small text-uppercase text-muted mb-2 d-block">Custom Alias</label>
          <input type="text" class="form-control" id="keyPhrase" placeholder="Optional">
        </div>

        <button class="btn btn-tech w-100 mb-4" id="addBtn" onclick="shorturl()">
          SYNCHRONIZE & SHORTEN
        </button>

        <div class="pt-3 border-top border-secondary">
          <div class="d-flex justify-content-between align-items-center mb-2 text-muted small">
            <span>Terminal Key</span>
            <span class="badge bg-secondary">Secure</span>
          </div>
          <input class="form-control form-control-sm text-center border-0 code-font" 
                 style="background:transparent; color: var(--accent-color)" 
                 type="text" value="__PASSWORD__" readonly id="passwordText">
        </div>
      </div>
    </div>

    <div class="glass-card mx-auto overflow-hidden">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="small">DATABASE</span>
        <button class="btn btn-sm btn-outline-info border-0" onclick="loadKV()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
        </button>
      </div>
      <div class="card-body p-4" style="max-height: 400px; overflow-y: auto;">
        <div id="urlList"></div>
      </div>
    </div>

  </div>

  <div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content glass-card border-0">
        <div class="modal-header border-0 pb-0">
          <h5 class="text-info w-100 text-center">LINK READY</h5>
        </div>
        <div class="modal-body p-4 text-center">
          <div class="p-3 rounded-4 bg-dark border border-secondary mb-4 code-font" 
               id="result" style="cursor: pointer; color: #00f2fe; word-break: break-all;"
               onclick="copyText()"></div>
          <div id="qrcode" class="d-inline-block p-3 bg-white rounded-4 shadow-lg mb-3"></div>
          <p class="small text-muted">Click the link box to copy</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/lrsjng/jquery-qrcode@0.18.0/dist/jquery-qrcode.min.js"></script>

  <script>
    const currentOrigin = window.location.origin;
    const apiPath = window.location.pathname;

    function shorturl() {
      let longURL = document.querySelector("#longURL").value;
      let keyPhrase = document.querySelector("#keyPhrase").value.trim().replace(/\s/g, "-");
      let password = document.querySelector("#passwordText").value;
      const btn = document.getElementById("addBtn");

      if (!longURL) return;
      btn.disabled = true;
      btn.innerHTML = 'SYNCING...';

      fetch(apiPath, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cmd: "add", url: longURL, key: keyPhrase, password: password })
      }).then(res => res.json()).then(data => {
        btn.disabled = false;
        btn.innerHTML = 'SYNCHRONIZE & SHORTEN';
        if (data.status === 200) {
          let finalUrl = currentOrigin + "/" + data.key;
          document.getElementById("result").innerText = finalUrl;
          $("#qrcode").empty().qrcode({ text: finalUrl, size: 160, fill: '#0f172a', background: '#ffffff', radius: 10 });
          new bootstrap.Modal(document.getElementById('resultModal')).show();
          loadKV();
        }
      }).catch(() => {
        btn.disabled = false;
        btn.innerHTML = 'RETRY';
      });
    }

    function copyText() {
      navigator.clipboard.writeText(document.getElementById("result").innerText);
      alert("Link Copied to Clipboard!");
    }

    function loadKV() {
      fetch(apiPath, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cmd: "qryall", password: document.querySelector("#passwordText").value })
      }).then(res => res.json()).then(data => {
        if (data.status === 200) {
          let html = '';
          data.kvlist.forEach(item => {
            html += `
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="code-font text-info fw-bold">${item.key}</span>
                  <button class="btn btn-sm btn-link text-danger p-0 border-0" onclick="delKey('${item.key}')">REMOVE</button>
                </div>
                <div class="small text-muted text-truncate code-font">REF: ${item.value}</div>
              </div>`;
          });
          document.getElementById("urlList").innerHTML = html || '<div class="text-center text-muted">EMPTY DATABASE</div>';
        }
      });
    }

    function delKey(key) {
      if(!confirm("DELETE "+key+"?")) return;
      fetch(apiPath, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cmd: "del", key: key, password: document.querySelector("#passwordText").value })
      }).then(() => loadKV());
    }

    window.onload = loadKV;
  </script>
</body>
</html>
